<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Create Work Order</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600">
    <link rel="stylesheet" href="../css/fontawesome.min.css">
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/tooplate.css">
</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col-12" w3-include-html="../partials/top_nav.html"> </div>
        </div>
        <br/>
        <!-- row -->
        <div class="row">
            <div class="col-xl-8 col-lg-10 col-md-12 col-sm-12">
                <div class="bg-white tm-block">
                    <div class="row">
                        <div class="col-12">
                        <div id="notification"></div>
                            <h2 class="tm-block-title d-inline-block">Work Order</h2>
                        </div>
                    </div>
                    <div class="row mt-4 tm-edit-product-row">
                        <div class="col-xl-7 col-lg-7 col-md-12">
                            <form action="" class="tm-edit-product-form" id="createWorkOrderForm">
                               <input type="hidden" id="workOrderId" name="id"/>
                                <div class="input-group mb-3">
                                    <label for="category" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Customer</label>
                                    <select name="customerId" id="customerId" class="custom-select col-xl-9 col-lg-8 col-md-8 col-sm-7">

                                    </select>
                                </div>
                       
                               <div class="input-group mb-3">
                                    <label for="category" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Type</label>
                                    <select name="type" id="type" class="custom-select col-xl-9 col-lg-8 col-md-8 col-sm-7">
                                        <option value="Service" selected>Service</option>
                                        <option value="Installation">Installation</option>
                                    </select>
                                </div>
                                
                                <div class="input-group mb-13">
                                    <label for="contactPersonId" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Contact Person <i class="far fa-plus-square" id="replacedSparePart" onclick="addContactPersonButton()"></i></label>
                                    <select name="contactPersonId" id="contactPersonId" class="custom-select col-xl-9 col-lg-8 col-md-8 col-sm-7">

                                    </select>                        
                                </div>
                                
					               <div id="addContactPersonDiv">
						               <div class="input-group mb-3">
						                   <label for="firstName" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">First name</label>
						                   <input id="firstName" name="firstName" type="text" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7">
						               </div>
						               <div class="input-group mb-3">
						                   <label for="lastName" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Last name</label>
						                   <input id="lastName" name="lastName" type="text" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7">
						               </div>
						               <div class="input-group mb-3">
						                   <label for="designation" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Designation</label>
						                   <input id="designation" name="designation" type="text" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7">
						               </div>
						               <div class="input-group mb-3">
						                   <label for="phone" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Phone</label>
						                   <input id="phone" name="phone" type="text" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7">
						               </div>
						               <div class="input-group mb-3">
						                   <label for="mobile" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Mobile</label>
						                   <input id="mobile" name="mobile" type="text" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7">
						               </div>
						               <div class="input-group mb-3">
						                   <label for="alternatePhone" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Alternate Phone</label>
						                   <input id="alternatePhone" name="alternatePhone" type="text" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7">
						               </div>
						               <div class="input-group mb-3">
						                   <label for="email" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Email</label>
						                   <input id="email" name="email" type="text" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7">
						               </div>
					               </div>

                                <div class="input-group mb-3">
                                    <label for="category" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Category</label>
                                    <select name="categoryId" id="categoryId" class="custom-select col-xl-9 col-lg-8 col-md-8 col-sm-7">

                                    </select>
                                </div>

                                <div class="input-group mb-3">
                                    <label for="equipmentId" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Equipment</label>
                                    <select name="equipmentId" id="equipmentId" class="custom-select col-xl-9 col-lg-8 col-md-8 col-sm-7">

                                    </select>
                                </div>
  
                               <div class="input-group mb-3">
                                    <label for="brand" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Brand</label>
                                    <input id="brand" name="brand" type="text" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7">
                                </div>

                                <div class="input-group mb-3">
                                    <label for="model" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Model</label>
                                    <input id="model" name="model" type="text" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7">
                                </div>

                                <div class="input-group mb-3">
                                    <label for="serialNumber" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Serial Number</label>
                                    <input id="serialNumber" name="serialNumber" type="text" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7">
                                </div>
                                
                                <div class="input-group mb-3">
                                    <label for="partNumber" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Part Number</label>
                                    <input id="partNumber" name="partNumber" type="text" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7">
                                </div>
                                                             
                                <div class="input-group mb-3">
                                    <label for="description" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 mb-2">Notes</label>
                                    <textarea name="notes" id = "notes" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7" rows="5" placeholder="Notes" required></textarea>
                                </div>

                                <div class="input-group mb-3">
                                    <div class="ml-auto col-xl-8 col-lg-8 col-md-8 col-sm-7 pl-0">
                                        <button type="submit" class="btn btn-primary" id="submitButton">Save</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        <div class="col-xl-4 col-lg-12 tm-md-12 tm-sm-12 tm-col">
           <div class="bg-white tm-block h-50" id="serviceReport">
                <h2 class="tm-block-title d-inline-block">Service Reports</h2>
                
                <div id="serviceReportList"></div>
                
                
           </div>
           </br>
           <div class="bg-white tm-block h-20" id="serviceReport">
               <form action="" class="tm-edit-product-form" id="deleteWorkOrderForm">
                   <input type="hidden" id="deleteWorkOrderId" name="deleteWorkOrderId"/>
                   <button type="submit" class="btn btn-primary" id="deleteWorkOrderButton">Delete Work Order</button>
               </form>
           </div>
        </div>              
        </div>
        <div w3-include-html="../partials/footer.html"> </div>
    </div>

    <script src="../js/jquery-3.3.1.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/config.js"></script>
    <script src="../js/aishtrack.js"></script>
    <script>
        $(function () {
        	checkLogin();
        	includeHTML();
        	$("#addContactPersonDiv").hide();
        	
        	$("#categoryId").change(function () {
        		getEquipments(this.value);
            });
        	$("#customerId").change(function () {
        		getCustomerPersons(this.value);
            });

        	getAllInfoForPage();

        	$("#submitButton").on("click", function (e) {
        		$("#submitButton").attr("disabled", true);
                e.preventDefault();
                window.scrollTo(0,0);
                $("#notification").html("<center><img src='../img/Gear-3.1s-104px.gif'/></center>");
                $.ajax({
                    url : apiURLBase + "/createWorkOrder",
                    type : "POST",
                    data: getJSONFormData($('#createWorkOrderForm')),
                    dataType: "json",
                    contentType: 'application/json',
                    crossDomain: true,
            		success: function(data) {
            			if(!isNaN(data)) {
            			    $("#workOrderId").val(data);
            			}
            			$("#notification").html("<center><font color=\"green\">Work Order Updated</font></center>");
            		},
            		error: function(data) {
            			alert("Error creating work order.");
            		},
            		complete: function(data) {
            			$("#submitButton").attr("disabled", false);
            		}
            	});
                return false;
              });
        	
        	$("#deleteWorkOrderButton").on("click", function (e) {
        		if(confirm("Are you sure you want to delete this work order?")) {
	        		$("#deleteWorkOrderButton").attr("disabled", true);
	                e.preventDefault();
	                window.scrollTo(0,0);
	                $("#notification").html("<center><img src='../img/Gear-3.1s-104px.gif'/></center>");
	                $.ajax({
	                    url : apiURLBase + "/deleteWorkOrder",
	                    type : "POST",
	                    data: getJSONFormData($('#deleteWorkOrderForm')),
	                    dataType: "json",
	                    contentType: 'application/json',
	                    crossDomain: true,
	            		success: function(data) {
	            			$("#notification").html("<center><font color=\"green\">Work Order Deleted</font></center>");
	            		},
	            		error: function(data) {
	            			alert("Error deleting work order.");
	            		},
	            		complete: function(data) {
	            			$("#deleteWorkOrderButton").attr("disabled", false);
	            		}
	            	});
        		}
                return false;
              });
        })
        
        function addContactPersonButton() {
        	$("#addContactPersonDiv").toggle();
        }
        function checkForUpdate() {
        	urlParams = new URLSearchParams(window.location.search);
        	workOrderId = urlParams.get('workOrderId');
        	if(workOrderId != null) {
        		prefillWorkOrderData(workOrderId);
        		getServiceReports(workOrderId);
        	}
        }

        function getServiceReports(workOrderId) {
            $.ajax({
                url : apiURLBase + "/getServiceReports?workOrderId=" + workOrderId,
                type : "GET",
                dataType: "json",
                crossDomain: true,
        		success: function(data) {
        			jsonArray = JSON.parse(JSON.stringify(data));
        			fillServiceReports(jsonArray);
        		},
        		error: function(data) {
        			log("Error fetching service reports");
        		}
        	});
          }

        function fillServiceReports(serviceReports) {
        	html = "<a href=\"../serviceReports/createServiceReport.html?type=service&workOrderId=" + workOrderId + "\" class=\"btn btn-small btn-primary\">Assign Service Report</a><br/><br/>";
        	html += "<a href=\"../serviceReports/createServiceReport.html?type=installation&workOrderId=" + workOrderId + "\" class=\"btn btn-small btn-primary\">Assign Installation Report</a><br/><br/>";
        	if(serviceReports.length > 0) {
        		html+="Existing Service Reports";
	        	$.each(serviceReports, function(index, serviceReport){
	        		html+="<li class=\"tm-list-group-item\">";
	        		html+="<a href=\"" + htmlURLBase + "/serviceReports/viewServiceReport.html?serviceReportCode=" + serviceReport.code + "\">" + serviceReport.equipment + " (" +serviceReport.status + ")" + "</a>";
	        		html+="</li>";
	        	});
        	}
        	$("#serviceReportList").html(html);
        }

        function getAllInfoForPage() {
        	$("#notification").html("<center><img src='../img/Gear-3.1s-104px.gif'/></center>");
        	$.when(getCategories(), getCustomers()).done(function() {
        	    checkForUpdate();
        	});
        	$("#notification").html("");
        }
    </script>
</body>

</html>