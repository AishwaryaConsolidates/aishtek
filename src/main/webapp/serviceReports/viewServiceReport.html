<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Service Report</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600">
    <link rel="stylesheet" href="../css/fontawesome.min.css">
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/tooplate.css">
    <link rel="stylesheet" href="../vendors/jquery-ui-datepicker/jquery-ui.min.css" type="text/css" />
</head>

<body class="bg02">
    <div class="container">
        <div class="row">
            <div class="col-12" w3-include-html="../partials/top_nav.html"> </div>
        </div>
        <br/>    

            <div class="row tm-content-row tm-mt-big">
            <div class="tm-col tm-col-big">
                <div class="bg-white tm-block">
                    <div class="row">
                        <div class="col-12">
                            <h2 class="tm-block-title d-inline-block">Service Report</h2>
                        </div>
                    </div>
                        <table class="">
                        <tr><td>ID:</td><td><div id="reportId"/></td></tr>
                        <tr><td>Date:</td><td><div id="reportDate"/></td></tr>
                        <tr><td>Status:</td><td><div id="status"/></td></tr>
                        <tr><td>Customer:</td><td><div id="customerName"/></td></tr>
                        
                        <tr><td>Contact:</td><td><div id="contact"/></td></tr>
                        <tr><td>Address:</td><td><div id="address"/></td></tr>
                        
                        <tr><td>Category:</td><td><div id="category"/></td></tr>
                        <tr><td>Equipment:</td><td><div id="equipment"/></td></tr>
                        <tr><td>Brand:</td><td><div id="brand"/></td></tr>
                        <tr><td>Model:</td><td><div id="model"/></td></tr>
                        <tr><td nowrap>Serial Number:</td><td><div id="serialNumber"/></td></tr>
                        <tr><td nowrap>Part Number:</td><td><div id="partNumber"/></td></tr>
                        
                        <tr><td>Technicians:</td><td><div id="technicians"/></td></tr>
                        
                        <tr><td>Notes:</td><td><div id="notes"/></td></tr>
                        </table>
                </div>
            </div>
            <div class="tm-col tm-col-big">
              <form action="" class="tm-edit-product-form" id="addInstallationDetailForm">
                <div id="installationDetailsBlock" class="bg-white tm-block">
                    <h2 class="tm-block-title d-inline-block">Installation Details</h2><br/>
                    <input type="checkbox" aria-label="Checkbox" name="equipmentDamaged"> &nbsp; Equipment Damaged</br></br>
                    <div id="previousInstallationDetails"></div>
                    <input type="radio" id="idetail" name="idetail" aria-label="Radio" value="Gas">Gas &nbsp;&nbsp;
                    <input type="radio" id="idetail" name="idetail" aria-label="Radio" value="Steam">Steam &nbsp;&nbsp;
                    <input type="radio" id="idetail" name="idetail" aria-label="Radio" value="Electrical">Electrical<br/>
                    <input type="radio" id="idetail" name="idetail" aria-label="Radio" value="Refrigeration">Refrigeration&nbsp;&nbsp;
                    <input type="radio" id="idetail" name="idetail" aria-label="Radio" value="Plumbing">Plumbing<br/>
                    <a id ="addInstallationDetailButton" href="#" class="btn btn-primary">Add Detail</a>
                </div>
                
                <div id="installationDetail" style="display:none">
                <br/>
                <div id="installationDetailSection" class="bg-white tm-block">
                    
                    <input type="hidden" id="serviceReportId" name="serviceReportId"/>
                    <input type="hidden" id="detail" name="detail"/>
                    <h2 class="tm-block-title d-inline-block" id="installationDetailHeading"></h2><br/>

                     <div id="installationDetailElements">
                     
                     </div>
                     <div class="input-group mb-3">
                         <a id ="addInstallationDetail" href="#" class="btn btn-primary">Add Installation Detail</a>
                     </div>
                     
                </div>
                </div>
                </form>
            </div>
            <div class="tm-col tm-col-small">
                <div class="bg-white tm-block">
                    <a id="visitButton" href="#" class="btn btn-small btn-primary">Create Visit</a>
                </div>
                
                 <div id="visits" class="bg-white tm-block"></div>
                 
                 <div id="visitFilesList" class="bg-white tm-block"></div>
            </div>
        </div>

                    <div id="installationDetailElement"  style="display:none">
                         <input name="key" type="text" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7" value="SOME_VALUE" readonly>
                         <input name="value" type="text" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7">
                     </div>
                     
        <div w3-include-html="../partials/footer.html"> </div>
    </div>

    <script src="../js/jquery-3.3.1.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/config.js"></script>
    <script src="../js/aishtrack.js"></script>
    <script src="../js/amazon-cognito-identity.min.js"></script>
    <script>
        $(function () {
        	includeHTML();
        	urlParams = new URLSearchParams(window.location.search);
        	serviceReportCode = urlParams.get('serviceReportCode');

        	$("#addInstallationDetailButton").click(function (e) {
        		e.preventDefault();
        		$("#installationDetailElements").empty();
        		document.getElementById("installationDetailHeading").innerHTML = document.querySelector('input[name="idetail"]:checked').value;
        		$("#detail").val(document.querySelector('input[name="idetail"]:checked').value);
        		installationDetails[document.querySelector('input[name="idetail"]:checked').value].forEach(function(detail){
        			var newdiv = document.createElement('div');
                    divHTML = document.getElementById("installationDetailElement").innerHTML;
                    newdiv.innerHTML = divHTML.replace(/SOME_VALUE/g, detail);
                    document.getElementById("installationDetailElements").appendChild(newdiv);
        		});
        		document.getElementById("installationDetail").style.display = "block";
        	});
        	
        	getServiceReport(serviceReportCode);
        	var serviceReportId;
        	function getServiceReport(serviceReportCode) {
                $.ajax({
                    url : apiURLBase + "/viewServiceReport?serviceReportCode=" + serviceReportCode,
                    type : "GET",
                    dataType: "json",
                    crossDomain: true,
            		success: function(data) {
            			serviceReport = JSON.parse(JSON.stringify(data));
            			serviceReportId = serviceReport.id;
            			$("#serviceReportId").val(serviceReportId);
            			fillPage(serviceReport);
            			loadVisits(serviceReportId);
            			loadVisitFiles(serviceReportId)
            		},
            		error: function(data) {
            			log("Error fetching service report");
            		}
            	});
              }
        	
        	function fillPage(serviceReport) {
        		$("#reportId").html(serviceReport.id);
        		$("#reportType").html(serviceReport.type);
        		$("#reportDate").html(serviceReport.reportDate);
        		$("#status").html(serviceReport.status);
        		$("#customerName").html(serviceReport.customerName);
        		$("#contact").html(contact(serviceReport));
        		$("#address").html(address(serviceReport));
        		$("#category").html(serviceReport.category);
        		$("#equipment").html(serviceReport.equipment);
        		$("#brand").html(serviceReport.brand);
        		$("#model").html(serviceReport.model);
        		$("#serialNumber").html(serviceReport.serialNumber);
        		$("#partNumber").html(serviceReport.partNumber);
        		$("#technicians").html(serviceReport.technicians);
        		$("#notes").html(serviceReport.notes);
        		
        		if (serviceReport.type === "installation") {
        			html = "";
           		    var detailJSON = JSON.parse(serviceReport.installationDetails);
        		    Object.keys(detailJSON).forEach(function(key) {
        		    	html = html + "<b>" + key + "</b>";
        		    	html+= "<br/>";
        		    	html+= showJSON(detailJSON[key])
        		    });
        		    $("#previousInstallationDetails").html(html);
        		    document.getElementById("installationDetailsBlock").style.display = "block";
      		    } else {
      		    	document.getElementById("installationDetailsBlock").style.display = "none";
      		    }
            }

        	function address(serviceReport) {
        		return serviceReport.customerStreet + "<br/>" + serviceReport.customerArea + "<br/>" + serviceReport.customerCity + "<br/>" + serviceReport.customerState + " " + serviceReport.customerPincode; 
        	}
        	
        	function contact(serviceReport) {
        		return serviceReport.contactFirstName + " " + serviceReport.contactLastName + "  (" + serviceReport.contactDesignation + ")<br/>" + serviceReport.contactEmail + "<br/>" + serviceReport.contactPhone;
        	}
        	
        	$("#visitButton").on("click", function (e) {
                e.preventDefault();
                window.open(htmlURLBase + '/visits/updateVisit.html?serviceReportId='+serviceReportId,'_visit');   
        	});
        	
        	function loadVisits(serviceReportId) {
                $.ajax({
                    url : apiURLBase + "/getVisits?serviceReportId=" + serviceReportId,
                    type : "GET",
                    dataType: "json",
                    crossDomain: true,
            		success: function(data) {
            			jsonArray = JSON.parse(JSON.stringify(data));
            			listVisits(jsonArray);
            		},
            		error: function(data) {
            			console.log("Error fetching visits" + data);
            		}
            	});
              }
        	
        	function listVisits(visits) {
            	html = "Visits";
            	$.each(visits, function(index, visit){
            		customer = JSON.parse(JSON.stringify(visit));
            		html+="<li>";
            		html+="<a href=\"" + htmlURLBase + "/visits/updateVisit.html?visitId=" + visit.id + "\">" + visit.visitDate +"</i></a>";
            		html+="<//li>";
            	});
            	$("#visits").html(html);
            }
        	
        	function loadVisitFiles(serviceReportId) {
                $.ajax({
                    url : apiURLBase + "/getVisitFiles?serviceReportId=" + serviceReportId,
                    type : "GET",
                    dataType: "json",
                    crossDomain: true,
            		success: function(data) {
            			jsonArray = JSON.parse(JSON.stringify(data));
            			listVisitFiles(jsonArray);
            		},
            		error: function(data) {
            			console.log("Error fetching visit files" + data);
            		}
            	});
            }
            
            function listVisitFiles(visitFiles) {
            	if(visitFiles.length > 0) {
            		html = "Visit Files";
    	        	$.each(visitFiles, function(index, visitFile) {
    	        		html+="<li class=\"tm-list-group-item\">";
    	        		html+="<a target = \"_" + index +"\" href=\"" + visitFile.location + "\">" + visitFile.name + "</a>";
    	        		html+="</li>";
    	        	});
    	        	html+="</br>";
    	        	$("#visitFilesList").html(html);
            	}
            }
            
            $("#addInstallationDetail").click(function (e) {
        		e.preventDefault();
        		$.ajax({
                    url : apiURLBase + "/createInstallationDetail",
                    type : "POST",
                    data: getJSONFormData($('#addInstallationDetailForm')),
                    dataType: "json",
                    contentType: 'application/json',
                    crossDomain: true,
            		success: function(data) {
            			$("#installationDetailElements").empty();
            			document.getElementById("installationDetail").style.display = "none";
            			$("#notification").html("<center><font color=\"green\">Installation Detail Added</font></center>");
            		},
            		error: function(data) {
            			alert("Error adding installation detail, please try again.");
            		}
            	});
                return false;
        	});
        })
    </script>
</body>

</html>