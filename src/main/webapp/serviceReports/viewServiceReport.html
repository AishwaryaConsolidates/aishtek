<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Service Report</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600">
    <link rel="stylesheet" href="../css/fontawesome.min.css">
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/tooplate.css">
    <link rel="stylesheet" href="../vendors/jquery-ui-datepicker/jquery-ui.min.css" type="text/css" />
</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col-12" w3-include-html="../partials/top_nav.html"> </div>
        </div>
        <br/>    

            <div class="row tm-content-row tm-mt-big">
            <div class="tm-col tm-col-big">
                <div class="bg-white tm-block">
                    <div class="row">
                        <div class="col-12">
                            <h2 class="tm-block-title d-inline-block">Service Report <a href="#" class=showSR>(view)</a></h2>
                        </div>
                    </div>
                        <table class="">
                        <tr><td>ID:</td><td><div id="reportId"/></td></tr>
                        <tr><td>Date:</td><td><div id="reportDate"/></td></tr>
                        <tr><td>Status:</td><td><div id="status"/></td></tr>
                        <tr><td>Customer:</td><td><div id="customerName"/></td></tr>
                        
                        <tr><td>Contact:</td><td><div id="contact"/></td></tr>
                        <tr><td>Address:</td><td><div id="address"/></td></tr>
                        
                        <tr><td>Technicians:</td><td><div id="technicians"/></td></tr>
                        
                        <tr><td>Notes:</td><td><div id="notes"/></td></tr>                   
                        </table>
                        <br/><br/><br/>
                        <a id="createNewServiceReportButton" href="#" class="btn btn-small btn-primary">Create New Service Report</a>
                        
                </div>

                <br/>
                <div class="bg-white tm-block">
                <form action="" class="tm-edit-product-form" id="updateEmailForm">
                <input type="hidden" id="emailServiceReportId" name="emailServiceReportId"/>
                <div class="input-group mb-3">
                   <label for="additionalEmail" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Additional Email</label>
                   <input id="additionalEmail" name="additionalEmail" type="text" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7">
               </div>

               <button type="submit" class="btn btn-primary" id="updateEmailButton">Update Email</button>
               </form>
               
               <br/><br/>
               
               <button type="submit" class="btn btn-primary" id="sendFeedbackEmailButton">Send Feedback Email</button>
               
                </div>
            </div>

            <div class="tm-col tm-col-big">

            <div id="equipmentBlock" class="bg-white tm-block">
            <form action="" class="tm-edit-product-form" id="updateEquipmentForm">
            <input type="hidden" id="id" name="id"/>
            <h2 class="tm-block-title d-inline-block">Equipment</h2><br/>

                <div class="input-group mb-3">
                    <label for="category" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Category</label>
                    <select name="categoryId" id="categoryId" class="custom-select col-xl-9 col-lg-8 col-md-8 col-sm-7">

                    </select>
                </div>

                <div class="input-group mb-3">
                    <label for="equipmentId" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Equipment</label>
                    <select name="equipmentId" id="equipmentId" class="custom-select col-xl-9 col-lg-8 col-md-8 col-sm-7">

                    </select>
                </div>
               <div class="input-group mb-3">
                   <label for="brand" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Brand</label>
                   <input id="brand" name="brand" type="text" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7">
               </div>

               <div class="input-group mb-3">
                   <label for="model" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Model</label>
                   <input id="model" name="model" type="text" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7">
               </div>

               <div class="input-group mb-3">
                   <label for="serialNumber" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Serial Number</label>
                   <input id="serialNumber" name="serialNumber" type="text" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7">
               </div>

               <div class="input-group mb-3">
                   <label for="partNumber" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Part Number</label>
                   <input id="partNumber" name="partNumber" type="text" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7">
               </div>

               <button type="submit" class="btn btn-primary" id="updateEquipmentButton">Update Equipment</button>
            </form>
            </div>

            <br/>

              <form action="" class="tm-edit-product-form" id="addInstallationDetailForm">
                <div id="installationDetailsBlock" class="bg-white tm-block">
                    <h2 class="tm-block-title d-inline-block">Installation Details</h2><br/>
                    <input type="checkbox" aria-label="Checkbox" name="equipmentDamaged"> &nbsp; Equipment Damaged</br></br>
                    <div id="previousInstallationDetails"></div>
                    <input type="radio" id="idetail" name="idetail" aria-label="Radio" value="Gas">Gas &nbsp;&nbsp;
                    <input type="radio" id="idetail" name="idetail" aria-label="Radio" value="Steam">Steam &nbsp;&nbsp;
                    <input type="radio" id="idetail" name="idetail" aria-label="Radio" value="Electrical">Electrical<br/>
                    <input type="radio" id="idetail" name="idetail" aria-label="Radio" value="Refrigeration">Refrigeration&nbsp;&nbsp;
                    <input type="radio" id="idetail" name="idetail" aria-label="Radio" value="Plumbing">Plumbing<br/>
                    <a id ="addInstallationDetailButton" href="#" class="btn btn-primary">Add Detail</a>
                </div>
                
                <div id="installationDetail" style="display:none">
                <br/>
                <div id="installationDetailSection" class="bg-white tm-block">
                    
                    <input type="hidden" id="serviceReportId" name="serviceReportId"/>
                    <input type="hidden" id="detail" name="detail"/>
                    <h2 class="tm-block-title d-inline-block" id="installationDetailHeading"></h2><br/>

                     <div id="installationDetailElements">
                     
                     </div>
                     <div class="input-group mb-3">
                         <a id ="addInstallationDetail" href="#" class="btn btn-primary">Add Installation Detail</a>
                     </div>
                     
                </div>
                </div>
                </form>
            </div>
            <div class="tm-col tm-col-small">
                <div class="bg-white tm-block">
                    <a id="visitButton" href="#" class="btn btn-small btn-primary">Create Visit</a>
                </div>
                
                 <div id="visits" class="bg-white tm-block"></div>
                 
                 <div id="visitFilesList" class="bg-white tm-block"></div>
            </div>
        </div>

                    <div id="installationDetailElement"  style="display:none">
                         <input name="key" type="text" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7" value="SOME_VALUE" readonly>
                         <input name="value" type="text" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7">
                     </div>
                     
        <div w3-include-html="../partials/footer.html"> </div>
    </div>

    <script src="../js/jquery-3.3.1.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/config.js"></script>
    <script src="../js/aishtrack.js"></script>
    <script>
        $(function () {
        	checkLogin();
        	includeHTML();
        	var serviceReportStatus = "";
        	$("#categoryId").change(function () {
        		getEquipments(this.value);
            });
        	function getAllInfoForPage(serviceReportCode) {
            	$("#notification").html("<center><img src='../img/Gear-3.1s-104px.gif'/></center>");
            	$.when(getCategories()).done(function() {
            		getServiceReport(serviceReportCode);
            	});
            	$("#notification").html("");
            }

        	urlParams = new URLSearchParams(window.location.search);
        	serviceReportCode = urlParams.get('serviceReportCode');
        	getAllInfoForPage(serviceReportCode);

        	$(".showSR").click(function (e) {
        		window.open(htmlURLBase + "/serviceReports/printServiceReport.html?serviceReportCode=" + serviceReportCode);
        		return false;
        	});

        	$("#addInstallationDetailButton").click(function (e) {
        		e.preventDefault();
        		$("#installationDetailElements").empty();
        		document.getElementById("installationDetailHeading").innerHTML = document.querySelector('input[name="idetail"]:checked').value;
        		$("#detail").val(document.querySelector('input[name="idetail"]:checked').value);
        		installationDetails[document.querySelector('input[name="idetail"]:checked').value].forEach(function(detail){
        			var newdiv = document.createElement('div');
                    divHTML = document.getElementById("installationDetailElement").innerHTML;
                    newdiv.innerHTML = divHTML.replace(/SOME_VALUE/g, detail);
                    document.getElementById("installationDetailElements").appendChild(newdiv);
        		});
        		document.getElementById("installationDetail").style.display = "block";
        	});
        	
        	var serviceReportId;
        	function getServiceReport(serviceReportCode) {
        		$("#notification").html("<center><img src='../img/Gear-3.1s-104px.gif'/></center>");
                $.ajax({
                    url : apiURLBase + "/viewServiceReport?serviceReportCode=" + serviceReportCode,
                    type : "GET",
                    dataType: "json",
                    crossDomain: true,
            		success: function(data) {
            			serviceReport = JSON.parse(JSON.stringify(data));
            			serviceReportId = serviceReport.id;
            			serviceReportStatus = serviceReport.status;
            			$("#serviceReportId").val(serviceReportId);
            			$("#emailServiceReportId").val(serviceReportId);
            			fillPage(serviceReport);
            			loadVisits(serviceReportId);
            			loadVisitFiles(serviceReportId);
            			$("#notification").html("");
            			
            			$("#createNewServiceReportButton").click(function (e) {
                    		e.preventDefault();
                    		if(confirm("Are you sure you want to create a new service report?")) {
                                window.open(htmlURLBase + '/serviceReports/createServiceReport.html?type=service&workOrderId='+serviceReport.workOrderId + '&copyFromServiceReportId='+serviceReportId); 
                    		}
                    	});
            		},
            		error: function(data) {
            			$("#notification").html("");
            			log("Error fetching service report");
            		}
            	});
              }

        	function fillPage(serviceReport) {
        		$("#reportId").html(serviceReport.id);
        		$("#reportType").html(serviceReport.type);
        		$("#reportDate").html(serviceReport.reportDate);
        		$("#status").html(serviceReport.status);
        		$("#customerName").html(serviceReport.customerName);
        		$("#contact").html(contact(serviceReport));
        		$("#address").html(address(serviceReport));
        		$("#technicians").html(serviceReport.technicians);
        		$("#notes").html(serviceReport.notes);

        		$("#id").val(serviceReport.id);
        		$("#categoryId").val(serviceReport.categoryId);
        		$("#brand").val(serviceReport.brand);
        		$("#model").val(serviceReport.model);
        		$("#serialNumber").val(serviceReport.serialNumber);
        		$("#partNumber").val(serviceReport.partNumber);
        		
        		if(serviceReport.additionalEmail) {
        			$("#additionalEmail").val(serviceReport.additionalEmail);
        		} else {
        			$("#additionalEmail").val(serviceReport.contactEmail);
        		}
        		$.when(getEquipments(serviceReport.categoryId)).done(function() {
        			$("#equipmentId").val(serviceReport.equipmentId);
            	});

        		if (serviceReport.type === "installation") {
        			html = "";
           		    var detailJSON = JSON.parse(serviceReport.installationDetails);
        		    Object.keys(detailJSON).forEach(function(key) {
        		    	html = html + "<b>" + key + "</b>";
        		    	html+= "<br/>";
        		    	html+= showJSON(detailJSON[key])
        		    });
        		    $("#previousInstallationDetails").html(html);
        		    document.getElementById("installationDetailsBlock").style.display = "block";
      		    } else {
      		    	document.getElementById("installationDetailsBlock").style.display = "none";
      		    }
            }

        	function address(serviceReport) {
        		return serviceReport.customerStreet + "<br/>" + serviceReport.customerArea + "<br/>" + serviceReport.customerCity + "<br/>" + serviceReport.customerState + " " + serviceReport.customerPincode; 
        	}
        	
        	function contact(serviceReport) {
        		return serviceReport.contactFirstName + " " + serviceReport.contactLastName + "  (" + serviceReport.contactDesignation + ")<br/>" + serviceReport.contactEmail + "<br/>" + serviceReport.contactPhone;
        	}
        	
        	$("#visitButton").on("click", function (e) {
        		if(serviceReportStatus != "completed") {
                  e.preventDefault();
                  window.open(htmlURLBase + '/visits/updateVisit.html?serviceReportId='+serviceReportId + "&serviceReportCode=" + serviceReportCode,'_visit');
        		} else {
        			e.preventDefault();
        			alert("This service report has been completed, you cannot make any more changes to it");
        		}
        	});
        	
        	function loadVisits(serviceReportId) {
                $.ajax({
                    url : apiURLBase + "/getVisits?serviceReportId=" + serviceReportId,
                    type : "GET",
                    dataType: "json",
                    crossDomain: true,
            		success: function(data) {
            			jsonArray = JSON.parse(JSON.stringify(data));
            			listVisits(jsonArray);
            		},
            		error: function(data) {
            			console.log("Error fetching visits" + data);
            		}
            	});
              }
        	
        	function listVisits(visits) {
            	html = "Visits";
            	$.each(visits, function(index, visit){
            		customer = JSON.parse(JSON.stringify(visit));
            		html+="<li>";
            		html+="<a href=\"" + htmlURLBase + "/visits/updateVisit.html?visitId=" + visit.id + "&serviceReportCode=" + serviceReportCode + "\">" + visit.visitDate +"</i></a>";
            		html+="<//li>";
            	});
            	$("#visits").html(html);
            }
        	
        	function loadVisitFiles(serviceReportId) {
                $.ajax({
                    url : apiURLBase + "/getVisitFiles?serviceReportId=" + serviceReportId,
                    type : "GET",
                    dataType: "json",
                    crossDomain: true,
            		success: function(data) {
            			jsonArray = JSON.parse(JSON.stringify(data));
            			listVisitFiles(jsonArray);
            		},
            		error: function(data) {
            			console.log("Error fetching visit files" + data);
            		}
            	});
            }
            
            function listVisitFiles(visitFiles) {
            	if(visitFiles.length > 0) {
            		html = "Visit Files";
    	        	$.each(visitFiles, function(index, visitFile) {
    	        		html+="<li class=\"tm-list-group-item\">";
    	        		html+="<a target = \"_" + index +"\" href=\"" + visitFile.location + "\">" + visitFile.name + "</a>";
    	        		html+="</li>";
    	        	});
    	        	html+="</br>";
    	        	$("#visitFilesList").html(html);
            	}
            }
            
            $("#addInstallationDetail").click(function (e) {
        		e.preventDefault();
        		$.ajax({
                    url : apiURLBase + "/createInstallationDetail",
                    type : "POST",
                    data: getJSONFormData($('#addInstallationDetailForm')),
                    dataType: "json",
                    contentType: 'application/json',
                    crossDomain: true,
            		success: function(data) {
            			$("#installationDetailElements").empty();
            			document.getElementById("installationDetail").style.display = "none";
            			$("#notification").html("<center><font color=\"green\">Installation Detail Added</font></center>");
            		},
            		error: function(data) {
            			alert("Error adding installation detail, please try again.");
            		}
            	});
                return false;
        	});

            $("#updateEquipmentButton").on("click", function (e) {
            	if(serviceReportStatus != "completed") {
            		$("#updateEquipmentButton").attr("disabled", true);
                    e.preventDefault();
                    window.scrollTo(0,0);
                    $("#notification").html("<center><img src='../img/Gear-3.1s-104px.gif'/></center>");
                    $.ajax({
                        url : apiURLBase + "/updateServiceReportEquipment",
                        type : "POST",
                        data: getJSONFormData($('#updateEquipmentForm')),
                        dataType: "json",
                        contentType: 'application/json',
                        crossDomain: true,
                		success: function(data) {
                			$("#notification").html("<center><font color=\"green\">Service Report Updated</font></center>");
                		},
                		error: function(data) {
                			alert("Error updating service report.");
                		},
                		complete: function(data) {
                			$("#updateEquipmentButton").attr("disabled", false);
                		}
                	});
                    return false;
            	} else {
            		e.preventDefault();
        			alert("This service report has been completed, you cannot make any more changes to it");
            	}

              });

            $("#updateEmailButton").on("click", function (e) {
        		$("#updateEmailButton").attr("disabled", true);
                e.preventDefault();
                window.scrollTo(0,0);
                $("#notification").html("<center><img src='../img/Gear-3.1s-104px.gif'/></center>");
                $.ajax({
                    url : apiURLBase + "/updateServiceReportEmail",
                    type : "POST",
                    data: getJSONFormData($('#updateEmailForm')),
                    dataType: "json",
                    contentType: 'application/json',
                    crossDomain: true,
            		success: function(data) {
            			$("#notification").html("<center><font color=\"green\">Service Report Updated</font></center>");
            		},
            		error: function(data) {
            			alert("Error updating service report.");
            		},
            		complete: function(data) {
            			$("#updateEmailButton").attr("disabled", false);
            		}
            	});
                return false;
              });
            
            $("#sendFeedbackEmailButton").on("click", function (e) {
        		$("#sendFeedbackEmailButton").attr("disabled", true);
                e.preventDefault();
                window.scrollTo(0,0);
                $("#notification").html("<center><img src='../img/Gear-3.1s-104px.gif'/></center>");
                $.ajax({
                    url : apiURLBase + "/sendServiceReportFeedbackEmail",
                    type : "POST",
                    data: getJSONFormData($('#updateEmailForm')),
                    dataType: "json",
                    contentType: 'application/json',
                    crossDomain: true,
            		success: function(data) {
            			$("#notification").html("<center><font color=\"green\">Feedback Email Sent</font></center>");
            		},
            		error: function(data) {
            			alert("Error sending email.");
            		},
            		complete: function(data) {
            			$("#sendFeedbackEmailButton").attr("disabled", false);
            		}
            	});
                return false;
              });
        })
    </script>
</body>

</html>