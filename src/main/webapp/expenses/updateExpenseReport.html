<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Expense Report</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600">
    <link rel="stylesheet" href="../css/fontawesome.min.css">
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/tooplate.css">
    <link rel="stylesheet" href="../vendors/jquery-ui-datepicker/jquery-ui.min.css" type="text/css" />
</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col-12" w3-include-html="../partials/top_nav.html"> </div>
        </div>
        <br/>
        <!-- row -->
        <div class="row">
            <div class="col-xl-8 col-lg-10 col-md-12 col-sm-12">
                <div class="bg-white tm-block">
                    <div class="row">
                        <div class="col-12">
                        <div id="notification"></div>
                            <h2 class="tm-block-title d-inline-block">Tour Expenses Statement</h2>
                        </div>
                    </div>
                    <div class="row mt-4 tm-edit-product-row">
                        <div class="col-xl-7 col-lg-7 col-md-12">
                            <form action="" class="tm-edit-product-form" id="updateExpenseReportForm">
                               <input type="hidden" id="expenseReportId" name="id"/>
                               <input type="hidden" id="serviceReportId" name="serviceReportId"/>
                               <input type="hidden" id="customerId" name="customerId"/>
                               <input type="hidden" id="technicianId" name="technicianId"/>
                               <input type="hidden" id="technicianEmail" name="technicianEmail"/>
                               
                               <div class="input-group mb-3">
                                   <label for="brand" class="col-xl-8 8 col-md-8 col-sm-8 col-form-label">Carry Forward Amount</label>
                                   <input class="recalculate form-control validate col-xl-4 col-lg-4 col-md-4 col-sm-4" id="carryForwardAmount" name="carryForwardAmount" type="text" value=0>
                               </div>
                                
                                
                               <div class="input-group mb-3">
                                   <label for="brand" class="col-xl-8 8 col-md-8 col-sm-8 col-form-label">Advance Amount</label>
                                   <input class="recalculate form-control validate col-xl-4 col-lg-4 col-md-4 col-sm-4" id="advanceAmount" name="advanceAmount" type="text" value=0>
                               </div>
                                
                               <div class="input-group mb-3">
                                   <label for="brand" class="col-xl-8 8 col-md-8 col-sm-8 col-form-label">Advance Amount Date</label>
                                   <input class="form-control validate col-xl-6 col-lg-6 col-md-6 col-sm-6" id="advanceAmountDate" name="advanceAmountDate" type="text">
                               </div>
                               
                               <div class="input-group mb-3">
                                   <label for="brand" class="col-xl-8 8 col-md-8 col-sm-8 col-form-label">Total Expense Amount</label>
                                   <input class="form-control validate col-xl-4 col-lg-4 col-md-4 col-sm-4" id="totalExpenseAmount" name="totalExpenseAmount" type="text" value=0>
                               </div>
                               
                               <div class="input-group mb-3">
                                   <label for="brand" class="col-xl-8 8 col-md-8 col-sm-8 col-form-label">Amount Due</label>
                                   <input class="recalculate form-control validate col-xl-4 col-lg-4 col-md-4 col-sm-4" id="dueAmount" name="dueAmount" type="text" value=0>
                               </div>
                               
                               <div class="input-group mb-3">
                                   <label for="brand" class="col-xl-8 8 col-md-8 col-sm-8 col-form-label">Location</label>
                                   <input class="recalculate form-control validate col-xl-8 col-lg-8 col-md-8 col-sm-8" id="location" name="location" type="text">
                               </div>
                               
                               
                               <h4>Expenses </h4>

								<div id="expensesDiv">
                               </div>
                               <i class="far fa-plus-square" id="addSingleExpense" onclick="addEmptyExpense()"></i>
                                <div class="input-group mb-3">
                                    <div class="ml-auto col-xl-8 col-lg-8 col-md-8 col-sm-7 pl-0">
                                        <button type="submit" class="btn btn-primary" id="submitButton">Update</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
         <div class="col-xl-4 col-lg-12 tm-md-12 tm-sm-12 tm-col">
           <div class="bg-white tm-block h-30" id="serviceReport">
           <i class="fas fa-print" onclick="printExpenseReport()"></i>&nbsp;<i class="fas fa-trash" onclick="deleteExpenseReport()"></i>
           <h5 id="customerName"></h5>
           <h5 id="technicianName"></h5>
           </div>
        </div>
        </div>
        <div w3-include-html="../partials/footer.html"> </div>
    </div>

                                <div id="singleExpenseTemplate" style="display:none">
								<table id="expensesTable" style="width: 600px">
									<tr>
										<td width="50%"><label for="firstName" class="col-xl-4 col-lg-4 col-md-4 col-sm-4 col-form-label">Date</label>
											<input class="form-control validate col-xl-6 col-lg-6 col-md-6 col-sm-6" id="expenseDateCOUNT" name="expenseDate" type="text">
										</td>
										<td><label for="firstName"
											class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Type</label>
											<select name="expenseType" id="expenseTypeCOUNT" class="custom-select col-xl-9 col-lg-8 col-md-8 col-sm-7">
												<option value="Other">Expense Type</option>
												<option value="Boarding">Boarding</option>
												<option value="Conveyance Blr">Conveyance Blr</option>
												<option value="Conveyance Site">Conveyance Site</option>
												<option value="Fare">Fare</option>
												<option value="Lodging">Lodging</option>
												<option value="Miscellaneous">Miscellaneous</option>
												<option value="Purchase">Purchase</option>
												<option value="Telephone">Telephone</option>
										</select></td>
									</tr>
									<tr>
										<td colspan="2"><label for="firstName"
											class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Note</label>
											<input
											class="form-control validate col-xl-16 col-lg-16 col-md-16 col-sm-16"
											id="expenseNoteCOUNT" name="expenseNote" type="text"
											size="70"></td>
									</tr>		
									<tr>
										<td><label for="firstName"
											class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Amount</label>
											<input
											class="recalculate expAmount form-control validate col-xl-6 col-lg-6 col-md-6 col-sm-6"
											id="expenseAmountCOUNT" name="expenseAmount" type="text"
											size="12"></td>
											<td>&nbsp;</td>
									</tr>

								</table>
								<hr width="600"/>
                                </div>  
    <script src="../js/jquery-3.3.1.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/config.js"></script>
    <script src="../js/aishtrack.js"></script>
    <script src="../vendors/jquery-ui-datepicker/jquery-ui.min.js"></script>
    <script>
    var noOfExpenses = 0;
        $(function () {
        	checkLogin();
        	$("#technicianEmail").val(getUserEmail());

        	includeHTML();
         	var expensesTable = document.getElementById("expensesTable");
         	checkForUpdate();
         	
         	$('#advanceAmountDate').datepicker({
        	    dateFormat: 'dd/mm/yy'
        	});

         	$("#submitButton").on("click", function (e) {
                $("#submitButton").attr("disabled", true);
                e.preventDefault();
                window.scrollTo(0,0);
                $("#notification").html("<center><img src='../img/Gear-3.1s-104px.gif'/></center>");
                $.ajax({
                    url : apiURLBase + "/updateExpenseReport",
                    type : "POST",
                    data: getJSONFormData($('#updateExpenseReportForm')),
                    dataType: "json",
                    contentType: 'application/json',
                    crossDomain: true,
            		success: function(data) {
            			if(!isNaN(data)) {
            			    $("#id").val(data);
            			}
            			$("#notification").html("<center><font color=\"green\">Expense Report Updated</font></center>");
            		},
            		error: function(data) {
            			alert("Error updating expense report, please try again");
            		},
            		complete: function(data) {
            			$("#submitButton").attr("disabled", false);
            		}
            	});
                return false;
              });
        });
        
        function recalculate() {
        	totalExpenditure = 0;
        	$(".expAmount").each(function() {
        		totalExpenditure = +totalExpenditure + +$(this).val();
        	});
        	$("#totalExpenseAmount").val(totalExpenditure);
        	$("#dueAmount").val((+totalExpenditure - +$("#advanceAmount").val() - +$("#carryForwardAmount").val()).toFixed(2));
        }
        
        function checkForUpdate() {
        	urlParams = new URLSearchParams(window.location.search);
        	customerId = urlParams.get('customerId');
        	$("#customerId").val(customerId);
        	serviceReportId = urlParams.get('serviceReportId');
        	$("#serviceReportId").val(serviceReportId);
        	technicianId = urlParams.get('technicianId');
        	$("#technicianId").val(technicianId);
        	expenseReportId = urlParams.get('expenseReportId');
        	$("#expenseReportId").val(expenseReportId);
        	if(expenseReportId != null) {
        		prefillExpenseReport(expenseReportId);
        	} else {
        		addEmptyExpenses(0, 3);
        	}
        }
        
        function prefillExpenseReport(expenseReportId) {	
            $.ajax({
                url : apiURLBase + "/getExpenseReport?expenseReportId=" + expenseReportId,
                type : "GET",
                dataType: "json",
                crossDomain: true,
        		success: function(data) {
        			expenseReport = JSON.parse(JSON.stringify(data));
        			fillForm(expenseReport);
        		},
        		error: function(data) {
        			console.log("Error fetching expense report "+ data);
        		}
        	});
        }
        
        function fillForm(expenseReport) {
        	$("#reportId").html(expenseReport.id);
        	$("#expenseReportId").val(expenseReport.id);
        	$("#technicianId").val(expenseReport.technicianId);
        	$("#serviceReportId").val(expenseReport.serviceReportId);
        	$("#customerId").val(expenseReport.customerId);
        	$("#advanceAmount").val(expenseReport.advanceAmount);
        	$("#carryForwardAmount").val(expenseReport.carryForwardAmount);
        	$("#location").val(expenseReport.location);
        	$("#customerName").html(expenseReport.customerName);
        	$("#technicianName").html(expenseReport.technicianName);
        	$("#advanceAmountDate").val(expenseReport.advanceAmountDateString);
        	fillExpenses(expenseReport.expenses);
        	recalculate();
        }
        
        function fillExpenses(expenses) {
        	addEmptyExpenses(0, (expenses.length));
        	$.each(expenses, function(index, expense){
        		$("#"+"expenseDate"+index).val(expense.expenseDateString);
        		$("#"+"expenseType"+index).val(expense.expenseType);
        		$("#"+"expenseNote"+index).val(expense.notes);
        		$("#"+"expenseAmount"+index).val(expense.amount);
            });
        }
        
        function addEmptyExpenses(initial = 0, count = 3) {
         	var i;
         	for (i = initial; i < (initial + count); i++) {
         		expensesDiv.insertAdjacentHTML("beforeend", document.getElementById("singleExpenseTemplate").innerHTML.replace(/COUNT/g, i));

            	$('#expenseDate' + i).datepicker({
        	        dateFormat: 'dd/mm/yy'
        	    });
            	
            	$(".recalculate").change(function() {
                	recalculate();
                });
            	noOfExpenses++;
         	}       	
        }

        function addEmptyExpense() {
        	nextId = noOfExpenses++;
        	expensesDiv.insertAdjacentHTML("beforeend", document.getElementById("singleExpenseTemplate").innerHTML.replace(/COUNT/g, nextId));

            $('#expenseDate' + nextId).datepicker({
        	    dateFormat: 'dd/mm/yy'
        	});

            $(".recalculate").change(function() {
                recalculate();
            });
        }

        function printExpenseReport() {
        	window.open(htmlURLBase + "/expenses/printExpenseReport.html?id=" + urlParams.get('expenseReportId'));
        }

        function deleteExpenseReport() {
        	if(confirm("Are you sure you want to delete this expense statement?")) {
	        	$.ajax({
	                url : apiURLBase + "/deleteExpenseReport",
	                type : "POST",
	                data: getJSONFormData($('#updateExpenseReportForm')),
	                dataType: "json",
	                contentType: 'application/json',
	                crossDomain: true,
	        		success: function(data) {
	        			$("#notification").html("<center><font color=\"green\">Expense Report Updated</font></center>");
	        		},
	        		error: function(data) {
	        			alert("Error updating expense report, please try again");
	        		}
	        	});
        	}
        	return false;
        }
    </script>
</body>

</html>