<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Visit</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600">
    <link rel="stylesheet" href="../css/fontawesome.min.css">
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/tooplate.css">
    <link rel="stylesheet" href="../vendors/jquery-ui-datepicker/jquery-ui.min.css" type="text/css" />
</head>

<body class="bg02">
    <div class="container">
        <div class="row">
            <div class="col-12" w3-include-html="../partials/top_nav.html"> </div>
        </div>
        <br/>
        <!-- row -->
        <div class="row">
            <div class="col-xl-8 col-lg-10 col-md-12 col-sm-12">
                <div class="bg-white tm-block">
                    <div class="row">
                        <div class="col-12">
                        <div id="notification"></div>
                            <h2 class="tm-block-title d-inline-block">Visit</h2>
                        </div>
                    </div>
                    <div class="row mt-4 tm-edit-product-row">
                        <div class="col-xl-7 col-lg-7 col-md-12">
                            <form action="" class="tm-edit-product-form" id="updateVisitForm">
                               <input type="hidden" id="visitId" name="id"/>
                               <input type="hidden" id="serviceReportId" name="serviceReportId"/>
                                <div class="input-group mb-3">
                                    <label for="visitDate" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Visit Date</label>
                                    <input id="visitDate" name="visitDate" type="text" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7" data-large-mode="true">
                                </div>
                                
                                <div class="input-group mb-3">
                                    <label for="complaint" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 mb-2">Complaint</label>
                                    <textarea name="complaint" id ="complaint" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7" rows="5" placeholder="Complaint" required></textarea>
                                </div>

                                <div class="input-group mb-3">
                                    <label for="findings" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 mb-2">Findings</label>
                                    <textarea name="findings" id ="findings" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7" rows="5" placeholder="Findings" required></textarea>
                                </div>
                                
                                <div class="input-group mb-3">
                                    <label for="workDone" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 mb-2">Work Done</label>
                                    <textarea name="workDone" id ="workDone" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7" rows="5" placeholder="Work Done" required></textarea>
                                </div>
                                
                                <div class="input-group mb-3">
                                    <label for="customerRemarks" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 mb-2">Customer Remarks</label>
                                    <textarea name="customerRemarks" id = "customerRemarks" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7" rows="5" placeholder="Customer Remarks" required></textarea>
                                </div>
                                
                                <div id="recommendedSparePartTitle">
                                    <h3 class="tm-block-title d-inline-block">Recommended Spare Parts</h3>
                                    <i class="far fa-plus-square" id="recommendedSparePart" onclick="addSparePart('recommended')"></i>
                                </div>
                                <div id="recommendedSpareParts">
	                                <div class="input-group mb-3">
	                                    <label for="recommendedSparePartNumber" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Part Number</label>
	                                    <input id="recommendedSparePartNumber" name="recommendedSparePartNumber" type="text" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7">
	                                </div>
	                                
	                                <div class="input-group mb-3">
	                                    <label for="recommendedSparePartQuantity" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Quantity</label>
	                                    <input id="recommendedSparePartQuantity" name="recommendedSparePartQuantity" type="text" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7">
	                                </div>
	                                
	                                <div class="input-group mb-3">
	                                    <label for="recommendedSparePartDescription" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 mb-2">Description</label>
	                                    <textarea name="recommendedSparePartDescription" id = "recommendedSparePartDescription" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7" rows="5" placeholder="Description" required></textarea>
	                                </div>
                                </div>
                                
                                <div id="recommendedSparePartTemplate" style="display:none">
                                    <div class="input-group mb-3">
	                                    <label for="recommendedSparePartNumber" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Part Number</label>
	                                    <input id="recommendedSparePartNumber" name="recommendedSparePartNumber" type="text" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7">
	                                </div>
	                                
	                                <div class="input-group mb-3">
	                                    <label for="recommendedSparePartQuantity" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Quantity</label>
	                                    <input id="recommendedSparePartQuantity" name="recommendedSparePartQuantity" type="text" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7">
	                                </div>
	                                
	                                <div class="input-group mb-3">
	                                    <label for="recommendedSparePartDescription" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 mb-2">Description</label>
	                                    <textarea name="recommendedSparePartDescription" id = "recommendedSparePartDescription" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7" rows="5" placeholder="Description" required></textarea>
	                                </div>
                                </div>
                                <div id="replacedSparePartTitle">
                                    <h3 class="tm-block-title d-inline-block">Replaced Spare Parts</h3>
                                    <i class="far fa-plus-square" id="replacedSparePart" onclick="addSparePart('replaced')"></i>
                                </div>
                                
                                <div id="replacedSpareParts">
	                                <div class="input-group mb-3">
	                                    <label for="replacedSparePartNumber" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Part Number</label>
	                                    <input id="replacedSparePartNumber" name="replacedSparePartNumber" type="text" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7">
	                                </div>
	                                
	                                <div class="input-group mb-3">
	                                    <label for="replacedSparePartQuantity" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Quantity</label>
	                                    <input id="replacedSparePartQuantity" name="replacedSparePartQuantity" type="text" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7">
	                                </div>
	                                
	                                <div class="input-group mb-3">
	                                    <label for="replacedSparePartDescription" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 mb-2">Description</label>
	                                    <textarea name="replacedSparePartDescription" id = "replacedSparePartDescription" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7" rows="5" placeholder="Description" required></textarea>
	                                </div>
                                </div>
                                
                                <div id="replacedSparePartTemplate" style="display:none">
	                                <div class="input-group mb-3">
	                                    <label for="replacedSparePartNumber" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Part Number</label>
	                                    <input id="replacedSparePartNumber" name="replacedSparePartNumber" type="text" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7">
	                                </div>
	                                
	                                <div class="input-group mb-3">
	                                    <label for="replacedSparePartQuantity" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Quantity</label>
	                                    <input id="replacedSparePartQuantity" name="replacedSparePartQuantity" type="text" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7">
	                                </div>
	                                
	                                <div class="input-group mb-3">
	                                    <label for="replacedSparePartDescription" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 mb-2">Description</label>
	                                    <textarea name="replacedSparePartDescription" id = "replacedSparePartDescription" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7" rows="5" placeholder="Description" required></textarea>
	                                </div>                                
                                </div>
                                <div class="input-group mb-3">
                                    <div class="ml-auto col-xl-8 col-lg-8 col-md-8 col-sm-7 pl-0">
                                        <button type="submit" class="btn btn-primary" id="submitButton">Save</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>          
        </div>
     <br/>
     
     <div class="col-xl-8 col-lg-10 col-md-12 col-sm-12">
                     <div class="bg-white tm-block">
                    <div class="row">
                        <div class="col-12">
                        <div id="notification"></div>
                            <h2 class="tm-block-title d-inline-block">Visit Files</h2>
                            <i class="far fa-plus-square" id="replacedSparePart"></i>
                        </div>
                    </div>
                    <div class="row mt-4 tm-edit-product-row">
                        <div class="col-xl-7 col-lg-7 col-md-12">
                            <form action="" class="tm-edit-product-form" id="uploadVisitFileForm" enctype="multipart/form-data">
                               <input type="hidden" id="visitId" name="visitId"/>
                                <div id="visitFiles">
	                                <div class="input-group mb-3">
	                                    <label for="visitFileName" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">File Name</label>
	                                    <input id="visitFileName" name="visitFileName" type="text" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7">
	                                </div>
	                                
	                                <div class="input-group mb-3">
	                                    <input type="file" name="visitFile" id="visitFile"/>
	                                </div>  
                                </div>

                                <div class="input-group mb-3">
                                    <div class="ml-auto col-xl-8 col-lg-8 col-md-8 col-sm-7 pl-0">
                                        <button type="submit" class="btn btn-primary" id="fileSubmitButton">Upload File</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
           </div>     
        <div w3-include-html="../partials/footer.html"> </div>
    </div>

    <script src="../js/jquery-3.3.1.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/aishtrack.js"></script>
    <script src="../vendors/jquery-ui-datepicker/jquery-ui.min.js"></script>
    <script>
    var recommendedCounter = 1;
        $(function () {
        	includeHTML();
        	$('#visitDate').datepicker({
        	    dateFormat: 'dd/mm/yy'
        	});
        	checkForUpdate();
        	$("#submitButton").on("click", function (e) {
                e.preventDefault();
                $.ajax({
                    url : "https://4ompw72vyb.execute-api.ap-south-1.amazonaws.com/Prod/updateVisit",
                    type : "POST",
                    data: getJSONFormData($('#updateVisitForm')),
                    dataType: "json",
                    contentType: 'application/json',
                    crossDomain: true,
            		success: function(data) {
            			if(!isNaN(data)) {
            			    $("#id").val(data);
            			    $("#visitId").val(data);
            			}
            			$("#notification").html("<center><font color=\"green\">Visit Updated</font></center>");
            		},
            		error: function(data) {
            			alert("Error updating visit");
            		}
            	});
                return false;
              });
        	
        	$("#fileSubmitButton").on("click", function (e) {
                e.preventDefault();
                var getUrlParams = {};
                getUrlParams["uploadFileName"] = $('#visitFile')[0].files[0].name;
                getUrlParams["fileName"] = $("#visitFileName").val();
                getUrlParams["visitId"] = $("#visitId").val();
                $.ajax({
                    url : "https://4ompw72vyb.execute-api.ap-south-1.amazonaws.com/Prod/generatePreSignedURL",
                    type : "POST",
                    data: JSON.stringify(getUrlParams),
                    dataType: "json",
                    contentType: 'application/json',
                    crossDomain: true,
            		success: function(data) {
            	        uploadFile(data);
            		},
            		error: function(data) {
            			alert("Error getting presigned url");
            		}
            	});
                return false;
              });
        })
        
        function uploadFile(fileUploadURL) {
        	var theFormFile = $('#visitFile')[0].files[0];
        	$.ajax({
                url : fileUploadURL,
                type : "PUT",
                contentType: theFormFile.type,
                processData: false,
                data: theFormFile,
                crossDomain: true,
        		success: function(data) {
        	        alert("file uploaded");
        		},
        		error: function(data) {
        			alert("Error upload failed");
        		}
        	});
        }
        
        function checkForUpdate() {
        	urlParams = new URLSearchParams(window.location.search);
        	serviceReportId = urlParams.get('serviceReportId');
        	$("#serviceReportId").val(serviceReportId);
        	visitId = urlParams.get('visitId');
        	if(visitId != null) {
        		prefillVisit(visitId);
        	}
        }
        
        function prefillVisit(visitId) {	
            $.ajax({
                url : "https://4ompw72vyb.execute-api.ap-south-1.amazonaws.com/Prod/getVisit?visitId=" + visitId,
                type : "GET",
                dataType: "json",
                crossDomain: true,
        		success: function(data) {
        			visit = JSON.parse(JSON.stringify(data));
        			fillForm(visit);
        		},
        		error: function(data) {
        			log("Error fetching visit");
        		}
        	});
          }
        
        function fillForm(visit) {
        	$("#id").val(visit.id);
        	$("#visitId").val(visit.id);
        	$("#visitDate").val(visit.visitDate);
        	$("#serviceReportId").val(visit.serviceReportId);
        	$("#complaint").val(visit.complaint);
        	$("#findings").val(visit.findings);
        	$("#workDone").val(visit.workDone);
        	$("#customerRemarks").val(visit.customerRemarks);
        }
        
        function addSparePart(type) {
            var newdiv = document.createElement('div');
            newdiv.innerHTML = document.getElementById(type+"SparePartTemplate").innerHTML;
            document.getElementById(type+"SpareParts").appendChild(newdiv);
            recommendedCounter++;
        }
        
        function addVisitFile() {
            var newdiv = document.createElement('div');
            newdiv.innerHTML = document.getElementById("visitFileTemplate").innerHTML;
            document.getElementById("visitFiles").appendChild(newdiv);
        }
    </script>
</body>

</html>